name: Windows RDP via Tailscale (Clean)

on:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: "RDP runtime (max 360 minutes)"
        required: false
        default: "300"

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      RDP_USER: ${{ secrets.RDP_USER }}
      RDP_PASS: ${{ secrets.RDP_PASS }}
      TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}

    steps:
    - name: Restore data (first run safe)
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: sourab-data
        path: D:\sourab

    - name: Install & Connect Tailscale
      shell: pwsh
      run: |
        $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (-not (Test-Path $ts)) {
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $dst = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $url -OutFile $dst
          Start-Process msiexec.exe -ArgumentList "/i","`"$dst`"","/quiet","/norestart" -Wait
        }
        & $ts up --authkey $env:TS_AUTHKEY --hostname "sourab-rdp"
        $ip = & $ts ip -4 | Select-Object -First 1
        Write-Host "TAILSCALE IP: $ip"

    - name: Enable RDP (Public + NLA off)
      shell: pwsh
      run: |
        $u = $env:RDP_USER
        $p = $env:RDP_PASS
        $s = ConvertTo-SecureString $p -AsPlainText -Force

        if (-not (Get-LocalUser -Name $u -ErrorAction SilentlyContinue)) {
          New-LocalUser -Name $u -Password $s -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $u
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
        }

        # Enable RDP
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
          -Name fDenyTSConnections -Value 0

        # Disable NLA
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
          -Name UserAuthentication -Value 0

        # Allow RDP on all profiles
        Set-NetFirewallRule -DisplayGroup "Remote Desktop" -Profile Any -Enabled True

        Restart-Service TermService -Force

    - name: Prepare data folder
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path D:\sourab

    - name: Keep RDP alive
      shell: pwsh
      run: |
        $end = (Get-Date).AddMinutes([int]"${{ inputs.runtime_minutes }}")
        while ((Get-Date) -lt $end) {
          Write-Host "RDP running at $(Get-Date)"
          Start-Sleep 60
        }

    - name: Save data
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sourab-data
        path: D:\sourab
        retention-days: 7
